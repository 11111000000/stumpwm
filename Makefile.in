LISP=@LISP_PROGRAM@

clisp_OPTS=-K full -on-error exit ./make-image.lisp
sbcl_OPTS=--load ./make-image.lisp

LISP_OPTS= $(@LISP@_OPTS)

# You shouldn't have to edit past this

# This is copied from the .asd file. It'd be nice to have the list in
# one place, but oh well.
FILES=package.lisp primitives.lisp keysyms.lisp keytrans.lisp kmap.lisp input.lisp core.lisp user.lisp mode-line.lisp color.lisp stumpwm.lisp version.lisp make-image.lisp

all: stumpwm.info stumpwm

stumpwm.info: stumpwm.texi
	makeinfo stumpwm.texi

# FIXME: This rule is too hardcoded 
stumpwm.texi: stumpwm.texi.in
	sbcl --eval "(progn (require 'asdf) (require 'stumpwm) (load \"manual.lisp\"))" --eval "(progn (stumpwm::generate-manual) (sb-ext:quit))"

stumpwm: $(FILES)
	$(LISP) $(LISP_OPTS)

release:
	git-archive --format=tar --prefix=stumpwm-@PACKAGE_VERSION@/ HEAD > stumpwm-@PACKAGE_VERSION@.tar
	tar xf stumpwm-@PACKAGE_VERSION@.tar
	cd stumpwm-@PACKAGE_VERSION@ && tar zxf @PPCRE_PATH@/../cl-ppcre.tar.gz
	git log > stumpwm-@PACKAGE_VERSION@/ChangeLog
	cp configure stumpwm-@PACKAGE_VERSION@/
	tar zcf stumpwm-@PACKAGE_VERSION@.tgz stumpwm-@PACKAGE_VERSION@
	rm -fr stumpwm-@PACKAGE_VERSION@/ stumpwm-@PACKAGE_VERSION@.tar

upload-release:
	gpg -b stumpwm-@PACKAGE_VERSION@.tgz
	scp stumpwm-@PACKAGE_VERSION@.tgz stumpwm-@PACKAGE_VERSION@.tgz.sig sabetts@dl.sv.nongnu.org:/releases/stumpwm/

clean:
	rm -f *.fasl *.fas *.lib stumpwm
